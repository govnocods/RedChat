<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RedChat üí¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .message-animation {
        animation: slideIn 0.3s ease-out;
      }
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(220, 38, 38, 0.1);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(220, 38, 38, 0.3);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(220, 38, 38, 0.5);
      }
      body {
        background-color: #0a0e27;
      }
    </style>
  </head>
  <body class="h-screen flex flex-col overflow-hidden">
    <div class="flex flex-1 overflow-hidden">
      <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
      <aside class="w-80 bg-[#0f1422]/90 backdrop-blur-xl border-r border-red-900/30 flex flex-col shadow-2xl">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ -->
        <div class="p-6 border-b border-red-900/30">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-red-600 to-red-700 rounded-xl flex items-center justify-center shadow-lg shadow-red-900/50">
                <i data-lucide="message-circle" class="w-6 h-6 text-white"></i>
              </div>
              <h1 class="text-2xl font-bold bg-gradient-to-r from-red-400 to-red-600 bg-clip-text text-transparent">
                RedChat
              </h1>
            </div>
            <button 
              id="newChatBtn"
              class="p-2.5 hover:bg-red-900/20 rounded-xl transition-colors duration-200 group"
              title="–ù–æ–≤—ã–π —á–∞—Ç"
            >
              <i data-lucide="plus" class="w-5 h-5 text-gray-400 group-hover:text-red-400 transition-colors"></i>
            </button>
          </div>
          
          <!-- –ü–æ–∏—Å–∫ -->
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i data-lucide="search" class="w-4 h-4 text-gray-500"></i>
            </div>
            <input
              type="text"
              placeholder="–ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤..."
              class="w-full pl-10 pr-4 py-2.5 bg-[#0a0e27]/60 border border-red-900/30 rounded-xl text-white placeholder-gray-500 text-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-600/50 transition-all duration-200"
            />
          </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
        <div id="chat-list" class="flex-1 overflow-y-auto p-3 space-y-2">
          <div
            class="p-4 flex items-center gap-3 cursor-pointer hover:bg-red-900/20 rounded-xl transition-all duration-200 bg-red-900/10 border border-red-900/30 group"
            id="general-chat"
          >
            <div class="relative">
              <div class="w-12 h-12 bg-gradient-to-br from-red-600 to-red-700 rounded-xl flex items-center justify-center font-bold text-white shadow-lg shadow-red-900/50 group-hover:scale-110 transition-transform duration-200">
                <i data-lucide="users" class="w-6 h-6"></i>
              </div>
              <span class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 border-2 border-[#0a0e27] rounded-full"></span>
            </div>
            <div class="flex-1 min-w-0">
              <p class="font-semibold text-white truncate">–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π —á–∞—Ç</p>
              <p class="text-gray-400 text-sm truncate">–û—Å–Ω–æ–≤–Ω–æ–π –æ–±—â–∏–π —á–∞—Ç</p>
            </div>
          </div>
        </div>

        <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="p-4 border-t border-red-900/30 bg-[#0a0e27]/40">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3 flex-1 min-w-0">
              <div class="w-10 h-10 bg-gradient-to-br from-red-600 to-red-700 rounded-xl flex items-center justify-center font-bold text-white shadow-lg shadow-red-900/50">
                <span id="profileInitial" class="text-sm">?</span>
              </div>
              <div class="flex-1 min-w-0">
                <p id="profileName" class="font-medium text-white text-sm truncate">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
              </div>
            </div>
            <button 
              id="logoutBtn" 
              class="p-2.5 hover:bg-red-900/30 rounded-xl transition-colors duration-200 group ml-2"
              title="–í—ã—Ö–æ–¥"
            >
              <i data-lucide="log-out" class="w-5 h-5 text-gray-400 group-hover:text-red-400 transition-colors"></i>
            </button>
          </div>
        </div>
      </aside>

      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
      <main class="flex-1 flex flex-col bg-[#0f1422]/60 backdrop-blur-xl">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
        <header class="p-4 border-b border-red-900/30 bg-[#0a0e27]/40 backdrop-blur-sm flex items-center justify-between">
          <div class="flex items-center gap-4">
            <div class="relative">
              <div class="w-12 h-12 bg-gradient-to-br from-red-600 to-red-700 rounded-xl flex items-center justify-center shadow-lg shadow-red-900/50">
                <i data-lucide="users" class="w-6 h-6 text-white"></i>
              </div>
            </div>
            <div>
              <h2 class="font-semibold text-lg text-white">–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π —á–∞—Ç</h2>
              <p class="text-sm text-gray-400 flex items-center gap-2">
                <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                –û–Ω–ª–∞–π–Ω: 12
              </p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button 
              class="p-2.5 hover:bg-red-900/20 rounded-xl transition-colors duration-200 group"
              title="–ü–æ–∏—Å–∫"
            >
              <i data-lucide="search" class="w-5 h-5 text-gray-400 group-hover:text-red-400 transition-colors"></i>
            </button>
            <button 
              class="p-2.5 hover:bg-red-900/20 rounded-xl transition-colors duration-200 group"
              title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"
            >
              <i data-lucide="more-vertical" class="w-5 h-5 text-gray-400 group-hover:text-red-400 transition-colors"></i>
            </button>
          </div>
        </header>

        <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
        <div id="messages" class="flex-1 overflow-y-auto bg-gradient-to-b from-transparent to-[#0a0e27]/40 p-6 space-y-3"></div>

        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
        <footer class="p-4 border-t border-red-900/30 bg-[#0a0e27]/40 backdrop-blur-sm">
          <form id="messageForm" class="flex items-center gap-3">
            <button 
              type="button"
              class="p-3 hover:bg-red-900/20 rounded-xl transition-colors duration-200 group flex-shrink-0"
              title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª"
            >
              <i data-lucide="paperclip" class="w-5 h-5 text-gray-400 group-hover:text-red-400 transition-colors"></i>
            </button>
            
            <input
              id="messageInput"
              type="text"
              placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
              class="flex-1 p-3 rounded-xl bg-[#0f1422]/60 border border-red-900/30 focus:ring-2 focus:ring-red-600 focus:outline-none text-white placeholder-gray-500 transition-all duration-200"
              required
            />
            
            <button
              type="submit"
              class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white p-3 rounded-xl flex items-center justify-center shadow-lg shadow-red-900/50 hover:shadow-xl hover:shadow-red-900/60 transform hover:scale-105 active:scale-95 transition-all duration-200 flex-shrink-0"
              title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å"
            >
              <i data-lucide="send" class="w-5 h-5"></i>
            </button>
          </form>
        </footer>
      </main>
    </div>

    <script>
      lucide.createIcons();

      // ---- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–æ–∫–µ–Ω–∞ ----
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
      }

      function parseJwt(token) {
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split("")
              .map(function (c) {
                return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
              })
              .join("")
          );
          return JSON.parse(jsonPayload);
        } catch {
          return null;
        }
      }

      // ---- –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–æ–∫–µ–Ω–∞ ----
      const token = getCookie("jwt");
      const decoded = parseJwt(token);
      const username = decoded ? decoded.Username || decoded.username : "–ì–æ—Å—Ç—å";

      document.getElementById("profileName").textContent = username;
      document.getElementById("profileInitial").textContent = username[0].toUpperCase();

      // ---- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket ----
      const socket = new WebSocket("ws://localhost:8080/ws");

      const form = document.getElementById("messageForm");
      const input = document.getElementById("messageInput");
      const messages = document.getElementById("messages");

      socket.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        const div = document.createElement("div");
        div.classList.add("flex", "items-start", "gap-3", "message-animation");

        div.innerHTML = `
          <div class="w-9 h-9 bg-gradient-to-br from-red-600 to-red-700 rounded-xl flex items-center justify-center font-bold text-white shadow-lg shadow-red-900/50 flex-shrink-0">
            ${msg.username ? msg.username[0].toUpperCase() : "?"}
          </div>
          <div class="flex-1">
            <div class="bg-[#0f1422]/80 backdrop-blur-sm border border-red-900/30 text-white p-3 rounded-xl rounded-tl-none shadow-lg max-w-md">
              <p class="text-red-400 font-medium text-sm mb-1">${msg.username}</p>
              <p class="text-gray-100">${msg.content}</p>
            </div>
          </div>
        `;

        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      };

      // ---- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ----
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const content = input.value.trim();
        if (!content) return;
        socket.send(JSON.stringify({ content, username }));
        input.value = "";
      });

      // ---- –í—ã—Ö–æ–¥ ----
      document.getElementById("logoutBtn").addEventListener("click", () => {
        document.cookie = "jwt=; Max-Age=0; path=/;";
        window.location.href = "/login";
      });
    </script>
  </body>
</html>