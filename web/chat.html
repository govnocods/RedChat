<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RedChat üí¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .message-animation {
        animation: slideIn 0.3s ease-out;
      }
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(220, 38, 38, 0.1);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(220, 38, 38, 0.3);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(220, 38, 38, 0.5);
      }
      body {
        background-color: #0a0e27;
      }
      @media (max-width: 768px) {
        .sidebar-mobile {
          transform: translateX(-100%);
          transition: transform 0.3s ease-in-out;
        }
        .sidebar-mobile.open {
          transform: translateX(0);
        }
      }
      i[data-lucide="chevron-left"] {
        transition: transform 0.3s ease-in-out;
      }
      i[data-lucide="chevron-left"] {
        transition: transform 0.3s ease-in-out;
      }
    </style>
  </head>
  <body class="h-screen flex flex-col overflow-hidden">
    <!-- Overlay –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö -->
    <div 
      id="sidebarOverlay"
      class="md:hidden fixed inset-0 bg-black/50 z-40 hidden"
    ></div>

    <div class="flex flex-1 overflow-hidden">
      <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
      <aside 
        id="sidebar"
        class="sidebar-mobile fixed md:static inset-y-0 left-0 z-40 w-80 bg-[#0f1422]/95 md:bg-[#0f1422]/90 backdrop-blur-xl border-r border-red-900/30 flex flex-col shadow-2xl"
      >
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ -->
        <div class="p-4 md:p-6 border-b border-red-900/30">
          <div class="flex items-center justify-between mb-3 md:mb-4">
            <div class="flex items-center gap-2 md:gap-3">
              <div class="w-8 h-8 md:w-10 md:h-10 bg-gradient-to-br from-red-600 to-red-700 rounded-xl flex items-center justify-center shadow-lg shadow-red-900/50">
                <i data-lucide="message-circle" class="w-5 h-5 md:w-6 md:h-6 text-white"></i>
              </div>
              <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-red-400 to-red-600 bg-clip-text text-transparent">
                RedChat
              </h1>
            </div>
            <div class="flex items-center gap-2">
              <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö -->
              <button 
                id="sidebarClose"
                class="md:hidden p-2 hover:bg-red-900/20 rounded-xl transition-colors duration-200"
                title="–ó–∞–∫—Ä—ã—Ç—å"
              >
                <i data-lucide="x" class="w-5 h-5 text-gray-400"></i>
              </button>
              <button 
                id="newChatBtn"
                class="hidden md:block p-2.5 hover:bg-red-900/20 rounded-xl transition-colors duration-200 group"
                title="–ù–æ–≤—ã–π —á–∞—Ç"
              >
                <i data-lucide="plus" class="w-5 h-5 text-gray-400 group-hover:text-red-400 transition-colors"></i>
              </button>
            </div>
          </div>
          
          <!-- –ü–æ–∏—Å–∫ -->
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i data-lucide="search" class="w-4 h-4 text-gray-500"></i>
            </div>
            <input
              type="text"
              placeholder="–ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤..."
              class="w-full pl-10 pr-4 py-2 md:py-2.5 bg-[#0a0e27]/60 border border-red-900/30 rounded-xl text-white placeholder-gray-500 text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-600/50 transition-all duration-200"
            />
          </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
        <div id="chat-list" class="flex-1 overflow-y-auto p-2 md:p-3 space-y-2">
          <div
            class="p-3 md:p-4 flex items-center gap-2 md:gap-3 cursor-pointer hover:bg-red-900/20 active:bg-red-900/30 rounded-xl transition-all duration-200 bg-red-900/10 border border-red-900/30 group chat-item"
            id="general-chat"
            data-chat-name="–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π —á–∞—Ç"
            data-chat-name="–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π —á–∞—Ç"
          >
            <div class="relative">
              <div class="w-10 h-10 md:w-12 md:h-12 bg-gradient-to-br from-red-600 to-red-700 rounded-xl flex items-center justify-center font-bold text-white shadow-lg shadow-red-900/50 group-hover:scale-110 transition-transform duration-200">
                <i data-lucide="users" class="w-5 h-5 md:w-6 md:h-6"></i>
              </div>
              <span class="absolute -top-1 -right-1 w-3 h-3 md:w-4 md:h-4 bg-red-500 border-2 border-[#0a0e27] rounded-full"></span>
            </div>
            <div class="flex-1 min-w-0">
              <p class="font-semibold text-white text-sm md:text-base truncate">–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π —á–∞—Ç</p>
              <p class="text-gray-400 text-xs md:text-sm truncate hidden md:block">–û—Å–Ω–æ–≤–Ω–æ–π –æ–±—â–∏–π —á–∞—Ç</p>
            </div>
          </div>
        </div>

        <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="p-3 md:p-4 border-t border-red-900/30 bg-[#0a0e27]/40">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2 md:gap-3 flex-1 min-w-0">
              <div class="w-9 h-9 md:w-10 md:h-10 bg-gradient-to-br from-red-600 to-red-700 rounded-xl flex items-center justify-center font-bold text-white shadow-lg shadow-red-900/50">
                <span id="profileInitial" class="text-xs md:text-sm">?</span>
              </div>
              <div class="flex-1 min-w-0">
                <p id="profileName" class="font-medium text-white text-xs md:text-sm truncate">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
              </div>
            </div>
            <button 
              id="logoutBtn" 
              class="p-2 md:p-2.5 hover:bg-red-900/30 rounded-xl transition-colors duration-200 group ml-2"
              title="–í—ã—Ö–æ–¥"
            >
              <i data-lucide="log-out" class="w-4 h-4 md:w-5 md:h-5 text-gray-400 group-hover:text-red-400 transition-colors"></i>
            </button>
          </div>
        </div>
      </aside>

      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
      <main class="flex-1 flex flex-col bg-[#0f1422]/60 backdrop-blur-xl w-full">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
        <header class="p-3 md:p-4 border-b border-red-900/30 bg-[#0a0e27]/40 backdrop-blur-sm flex items-center justify-between md:pl-4">
          <div class="flex items-center gap-2 md:gap-4 flex-1 min-w-0">
            <!-- –ö–Ω–æ–ø–∫–∞-—Å—Ç—Ä–µ–ª–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ -->
            <button
              id="sidebarToggle"
              class="p-1.5 md:p-2 hover:bg-red-900/20 rounded-lg transition-colors duration-200 group flex-shrink-0 -ml-1 md:ml-0"
              title="–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤"
            >
              <i data-lucide="chevron-left" class="w-5 h-5 md:w-6 md:h-6 text-gray-400 group-hover:text-red-400 transition-colors rotate-0 md:rotate-0"></i>
            </button>
            <div class="relative flex-shrink-0">
              <div class="w-10 h-10 md:w-12 md:h-12 bg-gradient-to-br from-red-600 to-red-700 rounded-xl flex items-center justify-center shadow-lg shadow-red-900/50 cursor-pointer hover:scale-105 transition-transform duration-200">
                <i data-lucide="users" class="w-5 h-5 md:w-6 md:h-6 text-white"></i>
              </div>
            </div>
            <div class="flex-1 min-w-0 cursor-pointer" id="chatHeaderInfo">
              <h2 class="font-semibold text-base md:text-lg text-white truncate">–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π —á–∞—Ç</h2>
              <p class="text-xs md:text-sm text-gray-400 flex items-center gap-2">
                <span class="w-1.5 h-1.5 md:w-2 md:h-2 bg-red-500 rounded-full flex-shrink-0"></span>
                <span class="truncate">–û–Ω–ª–∞–π–Ω: 12</span>
              </p>
            </div>
          </div>
          <div class="flex items-center gap-1 md:gap-2 flex-shrink-0">
            <button 
              class="hidden md:block p-2.5 hover:bg-red-900/20 rounded-xl transition-colors duration-200 group"
              title="–ü–æ–∏—Å–∫"
            >
              <i data-lucide="search" class="w-5 h-5 text-gray-400 group-hover:text-red-400 transition-colors"></i>
            </button>
            <button 
              class="p-2 md:p-2.5 hover:bg-red-900/20 rounded-xl transition-colors duration-200 group"
              title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"
            >
              <i data-lucide="more-vertical" class="w-4 h-4 md:w-5 md:h-5 text-gray-400 group-hover:text-red-400 transition-colors"></i>
            </button>
          </div>
        </header>

        <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
        <div id="messages" class="flex-1 overflow-y-auto bg-gradient-to-b from-transparent to-[#0a0e27]/40 p-3 md:p-6 space-y-2 md:space-y-3"></div>

        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
        <footer class="p-2 md:p-4 border-t border-red-900/30 bg-[#0a0e27]/40 backdrop-blur-sm safe-area-inset-bottom">
          <form id="messageForm" class="flex items-center gap-2 md:gap-3">
            <button 
              type="button"
              class="hidden md:block p-3 hover:bg-red-900/20 rounded-xl transition-colors duration-200 group flex-shrink-0"
              title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª"
            >
              <i data-lucide="paperclip" class="w-5 h-5 text-gray-400 group-hover:text-red-400 transition-colors"></i>
            </button>
            
            <div class="flex-1 relative">
              <input
                id="messageInput"
                type="text"
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                maxlength="5000"
                class="w-full p-2.5 md:p-3 pr-16 rounded-xl bg-[#0f1422]/60 border border-red-900/30 focus:ring-2 focus:ring-red-600 focus:outline-none text-white placeholder-gray-500 text-sm md:text-base transition-all duration-200"
                required
              />
              <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∏–º–≤–æ–ª–æ–≤ -->
              <span 
                id="charCount"
                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-gray-500 pointer-events-none"
                style="display: none;"
              >
                0/5000
              </span>
            </div>
            
            <button
              type="submit"
              class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white p-2.5 md:p-3 rounded-xl flex items-center justify-center shadow-lg shadow-red-900/50 hover:shadow-xl hover:shadow-red-900/60 transform hover:scale-105 active:scale-95 transition-all duration-200 flex-shrink-0"
              title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å"
            >
              <i data-lucide="send" class="w-4 h-4 md:w-5 md:h-5"></i>
            </button>
          </form>
        </footer>
      </main>
    </div>

    <script>
      lucide.createIcons();

      // ---- 1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ----
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
      }

      function parseJwt(token) {
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split("")
              .map(function (c) {
                return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
              })
              .join("")
          );
          return JSON.parse(jsonPayload);
        } catch {
          return null;
        }
      }

      // ---- –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–æ–∫–µ–Ω–∞ ----
      // Middleware —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é, –µ—Å–ª–∏ –º—ã –∑–¥–µ—Å—å - –∑–Ω–∞—á–∏—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã
      const token = getCookie("jwt");
      let username = "–ì–æ—Å—Ç—å";
      
      if (token) {
        const decoded = parseJwt(token);
        if (decoded) {
          username = decoded.Username || decoded.username || "–ì–æ—Å—Ç—å";
        }
      }

      // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const profileNameEl = document.getElementById("profileName");
      const profileInitialEl = document.getElementById("profileInitial");
      
      if (profileNameEl) {
        profileNameEl.textContent = escapeHtml(username);
      }
      if (profileInitialEl && username && username.length > 0) {
        profileInitialEl.textContent = escapeHtml(username[0].toUpperCase());
      }

      const form = document.getElementById("messageForm");
      const input = document.getElementById("messageInput");
      const messages = document.getElementById("messages");
      const charCount = document.getElementById("charCount");
      
      // ---- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∏–º–≤–æ–ª–æ–≤ ----
      if (input && charCount) {
        input.addEventListener("input", () => {
          const length = input.value.length;
          const maxLength = 5000;
          
          if (length > 0) {
            charCount.style.display = "block";
            charCount.textContent = `${length}/${maxLength}`;
            
            // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –ø—Ä–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ –∫ –ª–∏–º–∏—Ç—É
            if (length > maxLength * 0.9) {
              charCount.classList.remove("text-gray-500");
              charCount.classList.add("text-red-400");
            } else if (length > maxLength * 0.8) {
              charCount.classList.remove("text-red-400");
              charCount.classList.add("text-yellow-400");
            } else {
              charCount.classList.remove("text-red-400", "text-yellow-400");
              charCount.classList.add("text-gray-500");
            }
          } else {
            charCount.style.display = "none";
          }
        });
        
        input.addEventListener("blur", () => {
          if (input.value.length === 0) {
            charCount.style.display = "none";
          }
        });
      }

      // ---- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML ----
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // ---- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ ----
      function formatTime(dateString) {
        if (!dateString) return "";
        
        try {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return "";
          
          const hours = String(date.getHours()).padStart(2, '0');
          const minutes = String(date.getMinutes()).padStart(2, '0');
          return `${hours}:${minutes}`;
        } catch (e) {
          return "";
        }
      }

      // ---- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è ----
      function validateAndSanitizeMessage(content) {
        if (typeof content !== "string") {
          return "";
        }
        
        // Trim –ø—Ä–æ–±–µ–ª–æ–≤
        content = content.trim();
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (content.length === 0) {
          return "";
        }
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã (5000 —Å–∏–º–≤–æ–ª–æ–≤)
        if (content.length > 5000) {
          content = content.substring(0, 5000);
        }
        
        // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã:
        // - –ù—É–ª–µ–≤—ã–µ –±–∞–π—Ç—ã
        // - BOM
        // - –¢–æ–ª—å–∫–æ —Å–∞–º—ã–µ –æ–ø–∞—Å–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (–Ω–µ –≤—Å–µ –ø–æ–¥—Ä—è–¥!)
        content = content.replace(/\x00/g, ""); // –£–¥–∞–ª—è–µ–º –Ω—É–ª–µ–≤—ã–µ –±–∞–π—Ç—ã
        content = content.replace(/[\uFEFF]/g, ""); // –£–¥–∞–ª—è–µ–º BOM
        
        // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã:
        // \u0000-\u0008, \u000B-\u000C, \u000E-\u001F, \u007F-\u009F
        // –ù–û –æ—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (–ø—Ä–æ–±–µ–ª—ã, —Ç–∞–±—É–ª—è—Ü–∏—é –∏ —Ç.–¥.)
        content = content.replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F-\u009F]/g, "");
        
        return content;
      }

      // ---- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ ----
      function safeString(value) {
        if (value === null || value === undefined) {
          return "";
        }
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É –∏ —É–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        let str = String(value);
        // –£–¥–∞–ª—è–µ–º –Ω—É–ª–µ–≤—ã–µ –±–∞–π—Ç—ã
        str = str.replace(/\x00/g, "");
        return str;
      }

      // ---- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (–ë–ï–ó–û–ü–ê–°–ù–û) ----
      function displayMessage(msg) {
        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤:
        // WebSocket: {username, content, created_at}
        // API: {Username, Content, CreatedAt}
        let msgUsername = safeString(msg.username || msg.Username || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ");
        let msgContent = safeString(msg.content || msg.Content || "");
        let msgTime = msg.CreatedAt || msg.created_at || "";
        
        // –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏
        if (!msgContent || msgContent.trim().length === 0) {
          return;
        }
        
        // –¢—Ä–∏–º –ø—Ä–æ–±–µ–ª–æ–≤ —Ç–æ–ª—å–∫–æ –ø–æ –∫—Ä–∞—è–º (–Ω–µ –≤–Ω—É—Ç—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏—è)
        msgContent = msgContent.trim();
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã
        if (msgContent.length > 5000) {
          msgContent = msgContent.substring(0, 5000);
        }
        
        if (!msgUsername || msgUsername.trim().length === 0) {
          msgUsername = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
        }
        msgUsername = msgUsername.trim();

        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–ë–ï–ó innerHTML!)
        const div = document.createElement("div");
        div.classList.add("flex", "items-start", "gap-3", "message-animation");

        // –ê–≤–∞—Ç–∞—Ä
        const avatarDiv = document.createElement("div");
        avatarDiv.className = "w-8 h-8 md:w-9 md:h-9 bg-gradient-to-br from-red-600 to-red-700 rounded-xl flex items-center justify-center font-bold text-white shadow-lg shadow-red-900/50 flex-shrink-0 text-xs md:text-sm";
        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–π –±—É–∫–≤—ã
        const firstChar = msgUsername && msgUsername.length > 0 ? msgUsername[0] : "?";
        avatarDiv.textContent = firstChar.toUpperCase();
        
        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è
        const messageContainer = document.createElement("div");
        messageContainer.className = "flex-1 min-w-0";
        
        // –ö–∞—Ä—Ç–æ—á–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        const messageCard = document.createElement("div");
        messageCard.className = "bg-[#0f1422]/80 backdrop-blur-sm border border-red-900/30 text-white p-2.5 md:p-3 rounded-xl rounded-tl-none shadow-lg max-w-[85%] md:max-w-md";
        
        // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const usernameP = document.createElement("p");
        usernameP.className = "text-red-400 font-medium text-xs md:text-sm mb-0.5 md:mb-1 truncate";
        usernameP.textContent = msgUsername; // textContent –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—Å—Ç
        
        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∏ –≤—Ä–µ–º–µ–Ω–∏ (flex –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å–ø—Ä–∞–≤–∞)
        const contentTimeContainer = document.createElement("div");
        contentTimeContainer.className = "flex items-end justify-between gap-2";
        
        // –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        const contentP = document.createElement("p");
        contentP.className = "text-gray-100 text-sm md:text-base break-words whitespace-pre-wrap flex-1 min-w-0";
        contentP.textContent = msgContent; // textContent –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç HTML, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç
        
        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ –∏ –≥–∞–ª–æ—á–∫–∏
        const timeCheckContainer = document.createElement("div");
        timeCheckContainer.className = "flex items-center gap-1 flex-shrink-0";
        
        // –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É)
        const timeP = document.createElement("span");
        timeP.className = "text-gray-400 text-xs";
        timeP.textContent = formatTime(msgTime) || new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        
        // –ì–∞–ª–æ—á–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
        const checkIcon = document.createElement("i");
        checkIcon.setAttribute("data-lucide", "check");
        checkIcon.className = "w-3 h-3 text-blue-400";
        
        // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        timeCheckContainer.appendChild(timeP);
        timeCheckContainer.appendChild(checkIcon);
        messageCard.appendChild(usernameP);
        contentTimeContainer.appendChild(contentP);
        contentTimeContainer.appendChild(timeCheckContainer);
        messageCard.appendChild(contentTimeContainer);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ DOM
        messageContainer.appendChild(messageCard);
        div.appendChild(avatarDiv);
        div.appendChild(messageContainer);
        messages.appendChild(div);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∫–æ–Ω–∫—É Lucide –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ DOM
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
        
        messages.scrollTop = messages.scrollHeight;
      }

      // ---- –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ----
      async function loadMessages() {
        try {
          const response = await fetch("/api/messages?limit=50", {
            method: "GET",
            credentials: "include",
            headers: {
              "Content-Type": "application/json",
            },
          });

          // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ 401 (Unauthorized) - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ª–æ–≥–∏–Ω
          if (response.status === 401) {
            document.cookie = "jwt=; Max-Age=0; path=/;";
            window.location.href = "/login";
            return;
          }

          if (!response.ok) {
            console.error("Failed to load messages:", response.status);
            return;
          }

          const messagesData = await response.json();
          
          // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
          while (messages.firstChild) {
            messages.removeChild(messages.firstChild);
          }

          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
          if (Array.isArray(messagesData)) {
            messagesData.forEach((msg) => {
              displayMessage(msg);
            });
          }
        } catch (error) {
          console.error("Error loading messages:", error);
        }
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      loadMessages();

      // ---- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket ----
      const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const socket = new WebSocket(`${wsProtocol}//${window.location.host}/ws`);

      socket.onopen = () => {
        console.log("WebSocket connected");
      };

      socket.onerror = (error) => {
        console.error("WebSocket error:", error);
      };

      socket.onclose = (event) => {
        // –ö–æ–¥ 1008 = Policy Violation (–æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
        // –ö–æ–¥ 1002 = Protocol Error (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π)
        if (event.code === 1008 || event.code === 1002) {
          document.cookie = "jwt=; Max-Age=0; path=/;";
          window.location.href = "/login";
        } else if (event.code !== 1000) {
          // 1000 = Normal Closure (–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ)
          console.log("WebSocket closed:", event.code, event.reason);
        }
      };

      // ---- Rate limiting –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ ----
      const messageQueue = [];
      let lastMessageTime = 0;
      let messageCount = 0;
      const MESSAGE_RATE_LIMIT = 30; // –º–∞–∫—Å–∏–º—É–º —Å–æ–æ–±—â–µ–Ω–∏–π
      const RATE_LIMIT_WINDOW = 60000; // –∑–∞ 1 –º–∏–Ω—É—Ç—É (60 —Å–µ–∫—É–Ω–¥)
      const MIN_MESSAGE_INTERVAL = 2000; // –º–∏–Ω–∏–º—É–º 1 —Å–µ–∫—É–Ω–¥–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

      function canSendMessage() {
        const now = Date.now();
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        if (now - lastMessageTime < MIN_MESSAGE_INTERVAL) {
          return { allowed: false, reason: "–ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è" };
        }
        
        // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞, –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏
        if (now - lastMessageTime > RATE_LIMIT_WINDOW) {
          messageCount = 0;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        if (messageCount >= MESSAGE_RATE_LIMIT) {
          const remainingTime = Math.ceil((RATE_LIMIT_WINDOW - (now - lastMessageTime)) / 1000);
          return { allowed: false, reason: `–õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Å—á–µ—Ä–ø–∞–Ω. –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${remainingTime} —Å–µ–∫—É–Ω–¥.` };
        }
        
        return { allowed: true };
      }

      function showRateLimitError(message) {
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        const errorDiv = document.createElement("div");
        errorDiv.className = "fixed top-4 right-4 bg-red-900/90 border border-red-700/50 rounded-xl text-red-200 text-sm p-4 shadow-lg z-50 max-w-sm";
        errorDiv.textContent = message;
        
        document.body.appendChild(errorDiv);
        
        // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          if (errorDiv.parentNode) {
            errorDiv.parentNode.removeChild(errorDiv);
          }
        }, 3000);
      }

      socket.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          displayMessage(msg);
        } catch (err) {
          console.error("Error parsing WebSocket message:", err);
        }
      };

      // ---- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π ----
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        
        // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ input
        let content = input.value;
        
        // –ë–∞–∑–æ–≤—ã–π trim (—É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã —Ç–æ–ª—å–∫–æ –ø–æ –∫—Ä–∞—è–º)
        content = content.trim();
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (!content || content.length === 0) {
          return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã
        if (content.length > 5000) {
          showRateLimitError("–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 5000 —Å–∏–º–≤–æ–ª–æ–≤)");
          input.value = content.substring(0, 5000);
          return;
        }
        
        // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–ª–µ–≤—ã–µ –±–∞–π—Ç—ã (–æ—Å—Ç–∞–ª—å–Ω–æ–µ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å)
        content = content.replace(/\x00/g, "");
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limiting
        const rateCheck = canSendMessage();
        if (!rateCheck.allowed) {
          showRateLimitError(rateCheck.reason);
          return;
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        if (socket.readyState === WebSocket.CONNECTING) {
          showRateLimitError("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ...");
          return;
        }
        
        if (socket.readyState === WebSocket.CLOSING || socket.readyState === WebSocket.CLOSED) {
          showRateLimitError("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
          return;
        }
        
        if (socket.readyState !== WebSocket.OPEN) {
          showRateLimitError("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
          return;
        }
        
        try {
          const messageData = {
            content: content
          };
          
          socket.send(JSON.stringify(messageData));
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ rate limiting
          lastMessageTime = Date.now();
          messageCount++;
          
          // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
          input.value = "";
          
          // –°–∫—Ä—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
          if (charCount) {
            charCount.style.display = "none";
          }
        } catch (err) {
          console.error("Error sending message:", err);
          // –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
          let errorMsg = "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è";
          if (err instanceof Error) {
            errorMsg = `–û—à–∏–±–∫–∞: ${err.message}`;
          }
          showRateLimitError(errorMsg);
        }
      });

      // ---- –í—ã—Ö–æ–¥ ----
      document.getElementById("logoutBtn").addEventListener("click", () => {
        document.cookie = "jwt=; Max-Age=0; path=/;";
        window.location.href = "/login";
      });

      // ---- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª—å—é ----
      const sidebar = document.getElementById("sidebar");
      const sidebarToggle = document.getElementById("sidebarToggle");
      const sidebarClose = document.getElementById("sidebarClose");
      const sidebarOverlay = document.getElementById("sidebarOverlay");
      const chatHeaderInfo = document.getElementById("chatHeaderInfo");
      const chevronIcon = sidebarToggle?.querySelector("i");

      function openSidebar() {
        sidebar.classList.add("open");
        sidebarOverlay.classList.remove("hidden");
        // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        if (chevronIcon) {
          chevronIcon.style.transform = "rotate(180deg)";
        }
      }

      function closeSidebar() {
        sidebar.classList.remove("open");
        sidebarOverlay.classList.add("hidden");
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ
        if (chevronIcon) {
          chevronIcon.style.transform = "rotate(0deg)";
        }
      }

      // –û—Ç–∫—Ä—ã–≤–∞–µ–º/–∑–∞–∫—Ä—ã–≤–∞–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Å—Ç—Ä–µ–ª–∫—É
      sidebarToggle?.addEventListener("click", (e) => {
        e.stopPropagation();
        if (sidebar.classList.contains("open")) {
          closeSidebar();
        } else {
          openSidebar();
        }
      });

      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
      chatHeaderInfo?.addEventListener("click", () => {
        if (window.innerWidth < 768 && !sidebar.classList.contains("open")) {
          openSidebar();
        }
      });

      sidebarClose?.addEventListener("click", closeSidebar);
      sidebarOverlay?.addEventListener("click", closeSidebar);

      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —á–∞—Ç–∞
      document.querySelectorAll(".chat-item").forEach((item) => {
        item.addEventListener("click", () => {
          const chatName = item.getAttribute("data-chat-name");
          if (chatName) {
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —á–∞—Ç–∞
            const headerTitle = document.querySelector("header h2");
            if (headerTitle && chatName) {
              headerTitle.textContent = escapeHtml(chatName);
            }
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
            if (window.innerWidth < 768) {
              closeSidebar();
            }
          }
        });
      });

      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ Esc
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && sidebar.classList.contains("open")) {
          closeSidebar();
        }
      });

      // ---- –§—É–Ω–∫—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞ ----
      async function logout() {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.close();
        }
        
        // –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å cookie —á–µ—Ä–µ–∑ JavaScript (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        document.cookie = "jwt=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        document.cookie = "jwt=; Max-Age=0; path=/;";
        
        // –û—á–∏—â–∞–µ–º localStorage –∏ sessionStorage
        try {
          localStorage.clear();
          sessionStorage.clear();
        } catch (e) {
          // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
        }
        
        // –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è HttpOnly cookie
        try {
          await fetch('/api/logout', {
            method: 'POST',
            credentials: 'include',
          });
        } catch (e) {
          // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
          console.warn('Logout request failed:', e);
        }
        
        // –ó–∞–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–¥ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º
        window.history.replaceState(null, '', '/login');
        
        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ª–æ–≥–∏–Ω–∞ (replace –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞–∑–∞–¥)
        window.location.replace('/login');
      }

      // ---- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞ ----
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", (e) => {
          e.preventDefault();
          logout();
        });
      }

      // ---- –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ ----
      // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ popstate
      window.addEventListener('popstate', (e) => {
        // –ï—Å–ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ª–æ–≥–∏–Ω–∞, –Ω–æ –ø—ã—Ç–∞–µ–º—Å—è –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥
        if (window.location.pathname === '/login') {
          // –ó–∞–º–µ–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é, —á—Ç–æ–±—ã –Ω–µ–ª—å–∑—è –±—ã–ª–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è
          window.history.replaceState(null, '', '/login');
        }
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ –ø–æ—Å–ª–µ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π —Å DOM
      lucide.createIcons();
    </script>
  </body>
</html>